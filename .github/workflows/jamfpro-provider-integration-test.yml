name: "Terraform Integration Tests"
run-name: "Terraform Integration Tests"
on:
  workflow_dispatch:
  push:

jobs:
  Run-Integration-Test:
    environment: terraform-integration-testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Terraform Repository
        uses: actions/checkout@v4
        with:
          repository: deploymenttheory/terraform-provider-jamfpro
          # TODO: Change back to main
          ref: migrate-test-pipelines-and-infra
          path: terraform-provider-jamfpro

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Set up Golang
        uses: actions/setup-go@v5

      - name: Compile Provider
        run: |
          cd ./terraform-provider-jamfpro
          mkdir -p ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/
          go build
          mv ./terraform-provider-jamfpro ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/
          chmod +x ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/terraform-provider-jamfpro
          cd ~/.terraform.d 
          terraform init

      - name: Build TFVARS File
        run: |
          cd ./terraform-provider-jamfpro/tests/terraform
          cat << EOF > terraform.tfvars
          jamfpro_instance_fqdn="${{ secrets.TESTING_JAMFPRO_INSTANCE_FQDN }}"
          jamfpro_auth_method="oauth2"
          jamfpro_client_id="${{ secrets.MAINTENANCE_CLIENT_ID }}"
          jamfpro_client_secret=""
          jamfpro_token_refresh_buffer_period_seconds="30"
          jamfpro_mandatory_request_delay_milliseconds="100"
          EOF
          pwd
          cat terraform.tfvars
          ls
          
      - name: Run Tests
        run: |  
          cd ./terraform-provider-jamfpro/tests/terraform
          terraform fmt
          terraform init
          terraform test

      - name: Diff cascade - Terraform Plan (Pre-Apply)
        id: plan_pre
        run: |
          cd ./terraform-provider-jamfpro/tests/terraform
          chmod +x ./diff_cascade_check.sh
          ./diff_cascade_check.sh
          