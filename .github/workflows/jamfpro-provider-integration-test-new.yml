name: "Terraform Integration Tests - NEW"
run-name: "Terraform Integration Tests - NEW"
on:
  workflow_dispatch:
    inputs:  
      targets:
        description: 'Specify targets to test'
        type: string
        required: false
        default: 'all'

  pull_request:
    types: [opened, synchronize]

env:
  PR: ${{ github.event_name == 'pull_request' }}
  TARGETS: ${{ inputs.targets }}

jobs:
  Check-PR-Name:
    container: python:3.11-slim
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Run PR Name Check Script
        run: python3 scripts/check_pr_name.py ${{ github.event_name }}


  Run-Integration-Test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}/provider_testing:latest

    environment: ${{ (github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'workflow_dispatch') && 'provider-integration-testing-internal' || 'provider-integration-testing-external' }}

    concurrency:
      group: sandbox_interfacing_testing_environment
      cancel-in-progress: false

    env: 
      CLIENT_ID: ${{ secrets.TESTING_CLIENT_ID }}
      CLIENT_SEC: ${{ secrets.TESTING_CLIENT_SECRET }}
      CLIENT_FQDN: ${{ secrets.TESTING_JAMFPRO_INSTANCE_FQDN }}
      REF_TO_CHECKOUT: ${{ github.event_name == 'pull_request' && format('refs/pull/{0}/head', github.event.pull_request.number) || github.ref }}
    
    steps:
      - name: Checkout Terraform Repository
        uses: actions/checkout@v4
        with:
          repository: deploymenttheory/terraform-provider-jamfpro
          ref: ${{ env.REF_TO_CHECKOUT }}
          path: terraform-provider-jamfpro

        # From here, we're outside the provider
      - name: Compile Provider
        working-directory: terraform-provider-jamfpro/

        # Then we go into terraform/provider/jamfpro here
        run: |
          pwd

          mkdir -p ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/
          go build
          mv ./terraform-provider-jamfpro ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/
          chmod +x ~/.terraform.d/plugins/terraform.local/local/jamfpro/0.1.0/linux_amd64/terraform-provider-jamfpro

        
      # Running from provider root
      - name: Generate Test Targets
        if: github.event_name == 'pull_request' && env.TARGETS != 'compileonly'
        working-directory: terraform-provider-jamfpro/
        run: |
          pwd
          python3 scripts/get_targets_to_file.py \
          --repo-owner ${{ github.repository_owner }} \
          --repo-name ${{ github.event.repository.name }} \
          --pr-number ${{ github.event.pull_request.number }} \
          --github-token ${{ github.token }}

        
      # Relies on this file being at root of provider - does this matter?
      - name: Set Test Targets
        id: set-targets
        if: env.TARGETS != 'compileonly'
        working-directory: terraform-provider-jamfpro/
        run: |
          pwd
          if [ -f "target_resources.txt" ]; then
            targets=$(cat target_resources.txt)
          elif [ "$TARGETS" != "all" ] && [ ! -z "$TARGETS" ]; then
            targets="$TARGETS"
          else
            targets="all"
          fi
          echo "targets=$targets" >> $GITHUB_OUTPUT

        
      # Non-reliant on currnet dir
      - name: Generate UUID
        id: generate-uuid
        if: env.TARGETS != 'compileonly'
        run: |
          pwd
          generated_uuid=$(uuidgen)
          echo "uuid=$generated_uuid" >> $GITHUB_OUTPUT
          echo "Run ID: $generated_uuid"


      # Running from root of provider again
      - name: Populate Testing Directory
        id: generate-test-dir
        if: env.TARGETS != 'compileonly'
        working-directory: ./terraform-provider-jamfpro
        run: |
          pwd
          ls
          python3 scripts/generate_test_directory.py "${{ steps.set-targets.outputs.targets }}"

      # In Testing
      - name: Build TFVARS File
        if: env.TARGETS != 'compileonly'
        working-directory: terraform-provider-jamfpro/testing/
        run: |
          cat <<EOF > terraform.tfvars
          jamfpro_instance_fqdn="$CLIENT_FQDN"
          jamfpro_auth_method="oauth2"
          jamfpro_client_id="$CLIENT_ID"
          jamfpro_client_secret="$CLIENT_SEC"
          jamfpro_token_refresh_buffer_period_seconds="30"
          jamfpro_mandatory_request_delay_milliseconds="100"
          testing_id="${{ steps.generate-uuid.outputs.uuid }}"
          EOF

      
      # In Testing
      - name: Run Tests
        working-directory: terraform-provider-jamfpro/testing
        run: |
          pwd
          chmod +x scripts/run.sh
          scripts/run.sh "${{ steps.set-targets.outputs.targets }}" "${{ steps.generate-uuid.outputs.uuid }}"

      # Still in testing
      - name: Cleanup
        if: env.TARGETS != 'compileonly'
        working-directory: terraform-provider-jamfpro/testing
        run: |
          pwd
          # Waits 5 seconds to allow for deletes to properly apply after test.
          sleep 5
          chmod +x scripts/cleanup.sh
          scripts/cleanup.sh -r ${{ steps.generate-uuid.outputs.uuid }}

      # Still in testing
      - name: Diff cascade - Terraform Plan (Pre-Apply)
        id: plan_pre # What is this?
        if: env.TARGETS != 'compileonly'
        working-directory: terraform-provider-jamfpro/testing
        run: |
          pwd
          chmod +x scripts/diff_cascade_check.sh
          scripts/diff_cascade_check.sh
          